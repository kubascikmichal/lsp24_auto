from machine import Pin, I2C, Timer, ADC
from ssd1306 import SSD1306_I2C
import framebuf
import utime
import time, sys

# OLED pixel definition (WxH)
WIDTH  = 128 
HEIGHT = 32
# I2C0 pin assignments
SCL = 9  #22
SDA = 8  #21
#Initialize IO as output

bat = ADC(Pin(3))
bat.atten(ADC.ATTN_11DB)  #rozsah cca. 0 - 3.6V

# Initialize I2C0, Scan and Debug print of SSD1306 I2C device address
i2c = I2C(0, scl=Pin(SCL), sda=Pin(SDA), freq=400000)
k = i2c.scan()
print("Device Address      : ")
print(k)
# Initialize OLED
display = SSD1306_I2C(WIDTH, HEIGHT, i2c)

# 32x32 battery icon pixel array
b = [
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x03, 0xE0, 0x07, 0xC0, 0x07, 0xF0, 0x0F, 0xE0,
0x07, 0xF0, 0x0F, 0xE0, 0x07, 0xF0, 0x0F, 0xE0, 0x00, 0x00, 0x00, 0x00, 0x3F, 0xFF, 0xFF, 0xFC,
0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF,
0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFE, 0x3F,
0xFF, 0xFF, 0xFE, 0x3F, 0xF0, 0x1F, 0xF8, 0x0F, 0xF0, 0x1F, 0xF8, 0x0F, 0xF0, 0x1F, 0xF8, 0x0F,
0xFF, 0xFF, 0xFE, 0x3F, 0xFF, 0xFF, 0xFE, 0x3F, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF,
0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF,
0x7F, 0xFF, 0xFF, 0xFE, 0x3F, 0xFF, 0xFF, 0xFC, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00
]
battery = bytearray(b)

# Display image and text on OLED 
# Clear the display
display.fill(0)
# Write text in two lines
display.text("ESP32",10,8)
display.text("OLED Display",10,22)
display.show()
time.sleep(2)

def Kontrola_bat(tim1):
    pom = 4.07*bat.read()/4096
    k = int(pom*10)
    pom = k/10
    # battery icon with, text in 1 line
    display.fill(0)
    fb = framebuf.FrameBuffer(battery, 32, 32, framebuf.MONO_HLSB)
    display.blit(fb, 0, 0)
    display.text(str(pom),80,16)
    display.show()
 

tim1 = Timer(1)
tim1.init(period=1000, mode=Timer.PERIODIC, callback=Kontrola_bat)
    
time.sleep(5)

sys.exit(0)